<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>SpringFox源码解析 - 无名鼠辈</title><meta name="Description" content=""><meta property="og:title" content="SpringFox源码解析" />
<meta property="og:description" content="SpringFox源码分析-自定义Model、Enum 先说一说Springfox和Swagger的关系 Swagger 是一种规范。 springfox-swagger 是基于 Spring 生态系统的该规" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://llc687.top/posts/java/springfox%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%87%AA%E5%AE%9A%E4%B9%89modelenum/" /><meta property="og:image" content="https://llc687.top/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-12-01T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2019-12-01T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://llc687.top/logo.png"/>

<meta name="twitter:title" content="SpringFox源码解析"/>
<meta name="twitter:description" content="SpringFox源码分析-自定义Model、Enum 先说一说Springfox和Swagger的关系 Swagger 是一种规范。 springfox-swagger 是基于 Spring 生态系统的该规"/>
<meta name="application-name" content="无名鼠辈">
<meta name="apple-mobile-web-app-title" content="无名鼠辈"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://llc687.top/posts/java/springfox%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%87%AA%E5%AE%9A%E4%B9%89modelenum/" /><link rel="prev" href="https://llc687.top/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/hadoop%E4%B8%8Ehive/" /><link rel="next" href="https://llc687.top/posts/java/swagger-codegen%E4%BD%BF%E7%94%A8/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "SpringFox源码解析",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/llc687.top\/posts\/java\/springfox%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%87%AA%E5%AE%9A%E4%B9%89modelenum\/"
        },"genre": "posts","keywords": "SpringFox, Swagger","wordcount":  4604 ,
        "url": "https:\/\/llc687.top\/posts\/java\/springfox%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%87%AA%E5%AE%9A%E4%B9%89modelenum\/","datePublished": "2019-12-01T00:00:00+00:00","dateModified": "2019-12-01T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Lyf"},"author": {
                "@type": "Person",
                "name": "Lyf"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="无名鼠辈"><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 归档 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="无名鼠辈"><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">归档</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">SpringFox源码解析</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Lyf</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/swagger/"><i class="far fa-folder fa-fw"></i>Swagger</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2019-12-01">2019-12-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4604 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#springfox源码分析-自定义modelenum">SpringFox源码分析-自定义Model、Enum</a></li>
            <li><a href="#1-get-方法的参数对象">1. GET 方法的参数对象</a></li>
            <li><a href="#2-enum的描述格式">2. Enum的描述格式</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h4 id="springfox源码分析-自定义modelenum">SpringFox源码分析-自定义Model、Enum</h4>
<p>先说一说<a href="https://github.com/springfox/springfox" target="_blank" rel="noopener noreffer">Springfox</a>和Swagger的关系</p>
<blockquote>
<p>Swagger 是一种规范。</p>
<p>springfox-swagger 是基于 Spring 生态系统的该规范的实现。</p>
<p>springfox-swagger-ui 是对 swagger-ui 的封装，使得其可以使用 Spring 的服务。</p>
</blockquote>
<p>由于工作中遇到需要基于 Swagger Json 做一些处理，但 Swagger Json 的格式不是那么满足需求。</p>
<blockquote>
<p>本文springfox-swagger版本号：<code>2.6.0</code></p>
</blockquote>
<p>本文从问题出发，探索涉及的源码。</p>
<h4 id="1-get-方法的参数对象">1. GET 方法的参数对象</h4>
<p>第一个问题，当方法是GET请求，但参数是一个自定义 Object，在展示时（生成的JSON）是不包括本 Object 描述的。所以，就要看看什么时候会生成这些 Model 的描述。</p>
<p>万事有始有终，SpringFox始就在： <code>springfox.documentation.spring.web.plugins</code>下的 <code>DocumentationPluginsBootstrapper</code>。</p>
<p>该类实现了 <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/SmartLifecycle.html" target="_blank" rel="noopener noreffer">SmartLifecycle</a> 接口，实现此接口且通过<code>@Component</code>注入到容器的bean, 容器初始化后会执行<code>start()</code>方法.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DocumentationPluginsBootstrapper</span> <span class="kd">implements</span> <span class="n">SmartLifecycle</span> <span class="o">{</span>
</code></pre></td></tr></table>
</div>
</div><p>接着看 start 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initialized</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// 拿到 DocumentationPlugin 插件
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">DocumentationPlugin</span><span class="o">&gt;</span> <span class="n">plugins</span> <span class="o">=</span> <span class="n">pluginOrdering</span><span class="o">()</span>
            <span class="o">.</span><span class="na">sortedCopy</span><span class="o">(</span><span class="n">documentationPluginsManager</span><span class="o">.</span><span class="na">documentationPlugins</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">DocumentationPlugin</span> <span class="n">each</span> <span class="o">:</span> <span class="n">plugins</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//获取文档类型
</span><span class="c1"></span>            <span class="n">DocumentationType</span> <span class="n">documentationType</span> <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="na">getDocumentationType</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">each</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// 启用则扫描生成文档
</span><span class="c1"></span>                <span class="n">scanDocumentation</span><span class="o">(</span><span class="n">buildContext</span><span class="o">(</span><span class="n">each</span><span class="o">));</span>
            <span class="o">}</span> 
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>调用了 <code>buildContext</code> 方法, 通过 Docket 对象创建 DocumentaionContext 对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="n">DocumentationContext</span> <span class="nf">buildContext</span><span class="o">(</span><span class="n">DocumentationPlugin</span> <span class="n">each</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">each</span><span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultContextBuilder</span><span class="o">(</span><span class="n">each</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再往下走</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="n">DocumentationContextBuilder</span> <span class="nf">defaultContextBuilder</span><span class="o">(</span><span class="n">DocumentationPlugin</span> <span class="n">each</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">DocumentationType</span> <span class="n">documentationType</span> <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="na">getDocumentationType</span><span class="o">();</span>
    <span class="c1">// 获取所有的RequestHnadler
</span><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">RequestHandler</span><span class="o">&gt;</span> <span class="n">requestHandlers</span> <span class="o">=</span> <span class="n">FluentIterable</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">handlerProviders</span><span class="o">).</span><span class="na">transformAndConcat</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">handlers</span><span class="o">()).</span><span class="na">toList</span><span class="o">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">documentationPluginsManager</span><span class="o">.</span><span class="na">createContextBuilder</span><span class="o">(</span><span class="n">documentationType</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultConfiguration</span><span class="o">).</span><span class="na">requestHandlers</span><span class="o">(</span><span class="n">requestHandlers</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>handlerProviders</code> 是 <code>RequestHandlerProvider</code> 接口，实现类是 <code>WebMvcRequestHandlerProvider</code>,其中 <code>requestHandlers</code> 方法会接收Spring中的所有请求映射。</p>
<p>接着看 <code>DocumentationContextBuilder</code>的构造过程：<code>documentationPluginsManager.createContextBuilder</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">DocumentationContextBuilder</span> <span class="nf">createContextBuilder</span><span class="o">(</span><span class="n">DocumentationType</span> <span class="n">documentationType</span><span class="o">,</span>
                                                        <span class="n">DefaultConfiguration</span> <span class="n">defaultConfiguration</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">defaultsProviders</span><span class="o">.</span><span class="na">getPluginFor</span><span class="o">(</span><span class="n">documentationType</span><span class="o">,</span> <span class="n">defaultConfiguration</span><span class="o">)</span>
      <span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">documentationType</span><span class="o">)</span>
      <span class="o">.</span><span class="na">withResourceGroupingStrategy</span><span class="o">(</span><span class="n">resourceGroupingStrategy</span><span class="o">(</span><span class="n">documentationType</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>defaultsProviders</code> 是也是一个插件接口 <code>DefaultsProviderPlugin</code>，只有一个实现类<code>DefaultConfiguration</code>，不过该类未使用<code>@Compoent</code>注解，所以需要给一个替换值<code>defaultConfiguration</code>，也就是<code>DefaultConfiguration</code>。在看<code>DefaultConfiguration</code>的<code>create</code>方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">DocumentationContextBuilder</span> <span class="nf">create</span><span class="o">(</span><span class="n">DocumentationType</span> <span class="n">documentationType</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">DocumentationContextBuilder</span><span class="o">(</span><span class="n">documentationType</span><span class="o">)</span>
          <span class="o">.</span><span class="na">operationOrdering</span><span class="o">(</span><span class="n">defaults</span><span class="o">.</span><span class="na">operationOrdering</span><span class="o">())</span>
          <span class="o">.</span><span class="na">apiDescriptionOrdering</span><span class="o">(</span><span class="n">defaults</span><span class="o">.</span><span class="na">apiDescriptionOrdering</span><span class="o">())</span>
          <span class="o">.</span><span class="na">apiListingReferenceOrdering</span><span class="o">(</span><span class="n">defaults</span><span class="o">.</span><span class="na">apiListingReferenceOrdering</span><span class="o">())</span>
          <span class="o">.</span><span class="na">additionalIgnorableTypes</span><span class="o">(</span><span class="n">defaults</span><span class="o">.</span><span class="na">defaultIgnorableParameterTypes</span><span class="o">())</span>
          <span class="o">.</span><span class="na">rules</span><span class="o">(</span><span class="n">defaults</span><span class="o">.</span><span class="na">defaultRules</span><span class="o">(</span><span class="n">typeResolver</span><span class="o">))</span>
          <span class="o">.</span><span class="na">defaultResponseMessages</span><span class="o">(</span><span class="n">defaults</span><span class="o">.</span><span class="na">defaultResponseMessages</span><span class="o">())</span>
          <span class="o">.</span><span class="na">pathProvider</span><span class="o">(</span><span class="k">new</span> <span class="n">RelativePathProvider</span><span class="o">(</span><span class="n">servletContext</span><span class="o">))</span>
          <span class="o">.</span><span class="na">typeResolver</span><span class="o">(</span><span class="n">typeResolver</span><span class="o">)</span>
          <span class="o">.</span><span class="na">enableUrlTemplating</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
          <span class="o">.</span><span class="na">selector</span><span class="o">(</span><span class="n">ApiSelector</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里在给<code>DocumentationContextBuilder</code>设置相关参数，至此拿到了 <code>DocumentationContextBuilder</code></p>
<p>回到上面提到的<code>buildContext</code>方法，<code>defaultContextBuilder</code>方法执行完毕，接下来是 <code>configure</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="k">return</span> <span class="n">each</span><span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultContextBuilder</span><span class="o">(</span><span class="n">each</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><p><code>DocumentationPlugin</code>只有一个实现类<code>Docket</code>，到这里就有点熟悉了。<code>Docket</code>对象是我们开发人员在外部通过<code>@Bean</code>来创建的，而外部赋值的对象值，最终都会整合到<code>DocumentationContext</code>。这里的<code>config</code>就是在二次赋值。可以看一下一般自己定义的<code>Docket</code>对象。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SwaggerConfig</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Docket</span> <span class="nf">docket</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Docket</span><span class="o">(</span><span class="n">DocumentationType</span><span class="o">.</span><span class="na">SWAGGER_2</span><span class="o">)</span>
                <span class="o">.</span><span class="na">groupName</span><span class="o">(</span><span class="n">SWAGGER_GROUP</span><span class="o">)</span>
                <span class="o">.</span><span class="na">apiInfo</span><span class="o">(</span><span class="k">new</span> <span class="n">ApiInfoBuilder</span><span class="o">().</span><span class="na">title</span><span class="o">(</span><span class="s">&#34;xx&#34;</span><span class="o">).</span><span class="na">version</span><span class="o">(</span><span class="s">&#34;1.0.0&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">())</span>
                <span class="o">......</span>
                <span class="o">.</span><span class="na">select</span><span class="o">()</span>
                <span class="o">.</span><span class="na">apis</span><span class="o">(</span><span class="n">basePackage</span><span class="o">(</span><span class="s">&#34;xxx&#34;</span><span class="o">))</span>
                <span class="o">.</span><span class="na">paths</span><span class="o">(</span><span class="n">PathSelectors</span><span class="o">.</span><span class="na">any</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>到这里实际只设置了默认的参数。但接口，定义，模型等关键信息等都未初始化。</p>
<p>回到最初<code>start()</code>, 看看<code>scanDocumentation(buildContext(each))</code>的<code>scanDocumentation</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">scanDocumentation</span><span class="o">(</span><span class="n">DocumentationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">scanned</span><span class="o">.</span><span class="na">addDocumentation</span><span class="o">(</span><span class="n">resourceListing</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中 <code>scan</code> 位于 <code>ApiDocumentationScanner</code>类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="n">Documentation</span> <span class="nf">scan</span><span class="o">(</span><span class="n">DocumentationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">ApiListingReferenceScanResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">apiListingReferenceScanner</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">...</span>
  <span class="n">Multimap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ApiListing</span><span class="o">&gt;</span> <span class="n">apiListings</span> <span class="o">=</span> <span class="n">apiListingScanner</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span><span class="n">listingContext</span><span class="o">);</span>
  <span class="o">...</span>
</code></pre></td></tr></table>
</div>
</div><p><code>apiListingReferenceScanner.scan</code>位于 <code>ApiListingReferenceScanner</code>类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="n">ApiListingReferenceScanResult</span> <span class="nf">scan</span><span class="o">(</span><span class="n">DocumentationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="c1">// 接口选择器 在构建Docket时通过.select()默认配置 
</span><span class="c1"></span>  <span class="n">ApiSelector</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getApiSelector</span><span class="o">();</span>
  <span class="c1">// 根据package路径(一般)或注解区分, 过滤筛选掉不符规则的 RequestHandler 接口
</span><span class="c1"></span>  <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">RequestHandler</span><span class="o">&gt;</span> <span class="n">matchingHandlers</span> <span class="o">=</span> <span class="n">from</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getRequestHandlers</span><span class="o">())</span>
      <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">selector</span><span class="o">.</span><span class="na">getRequestHandlerSelector</span><span class="o">());</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">RequestHandler</span> <span class="n">handler</span> <span class="o">:</span> <span class="n">matchingHandlers</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 接口分组 resourceGroup = Controller，RequestMapping = method
</span><span class="c1"></span>    <span class="n">ResourceGroup</span> <span class="n">resourceGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceGroup</span><span class="o">(</span><span class="n">handler</span><span class="o">.</span><span class="na">groupName</span><span class="o">(),</span>
        <span class="n">handler</span><span class="o">.</span><span class="na">declaringClass</span><span class="o">(),</span> <span class="n">0</span><span class="o">);</span>
    <span class="n">RequestMappingContext</span> <span class="n">requestMappingContext</span>
        <span class="o">=</span> <span class="k">new</span> <span class="n">RequestMappingContext</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
    <span class="n">resourceGroupRequestMappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">resourceGroup</span><span class="o">,</span> <span class="n">requestMappingContext</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">ApiListingReferenceScanResult</span><span class="o">(</span><span class="n">asMap</span><span class="o">(</span><span class="n">resourceGroupRequestMappings</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>到这已经拿到了所有接口并进行了分组，其中<a href="https://guava.dev/releases/23.6-jre/api/docs/com/google/common/collect/ArrayListMultimap.html" target="_blank" rel="noopener noreffer">ArrayListMultimap</a>是<code>guava</code>的方法。</p>
<p>再回到  <code>ApiDocumentationScanner</code>的 <code>scan</code>方法，看 <code>apiListingScanner.scan</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="n">Multimap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ApiListing</span><span class="o">&gt;</span> <span class="nf">scan</span><span class="o">(</span><span class="n">ApiListingScanningContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">ResourceGroup</span> <span class="n">resourceGroup</span> <span class="o">:</span> <span class="n">sortedByName</span><span class="o">(</span><span class="n">requestMappingsByResourceGroup</span><span class="o">.</span><span class="na">keySet</span><span class="o">()))</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">RequestMappingContext</span> <span class="n">each</span> <span class="o">:</span> <span class="n">sortedByMethods</span><span class="o">(</span><span class="n">requestMappingsByResourceGroup</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">resourceGroup</span><span class="o">)))</span> <span class="o">{</span>
      <span class="c1">// 循环Controller下的所有接口的实例对象, 拿到该接口的所有Model
</span><span class="c1"></span>      <span class="n">models</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">apiModelReader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">each</span><span class="o">.</span><span class="na">withKnownModels</span><span class="o">(</span><span class="n">models</span><span class="o">)));</span>
      <span class="n">apiDescriptions</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">apiDescriptionReader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">each</span><span class="o">));</span>
    <span class="o">}</span>
    
</code></pre></td></tr></table>
</div>
</div><p><code>each.withKnownModels</code> 是复制对象，主要看<code>apiModelReader.read</code>,读取该接口的 Model 信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Model</span><span class="o">&gt;</span> <span class="nf">read</span><span class="o">(</span><span class="n">RequestMappingContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// 忽略的class
</span><span class="c1"></span>  <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">ignorableTypes</span> <span class="o">=</span> <span class="n">newHashSet</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getIgnorableParameterTypes</span><span class="o">());</span>
  <span class="n">Set</span><span class="o">&lt;</span><span class="n">ModelContext</span><span class="o">&gt;</span> <span class="n">modelContexts</span> <span class="o">=</span> <span class="n">pluginsManager</span><span class="o">.</span><span class="na">modelContexts</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Model</span><span class="o">&gt;</span> <span class="n">modelMap</span> <span class="o">=</span> <span class="n">newHashMap</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getModelMap</span><span class="o">());</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">ModelContext</span> <span class="n">each</span> <span class="o">:</span> <span class="n">modelContexts</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">markIgnorablesAsHasSeen</span><span class="o">(</span><span class="n">typeResolver</span><span class="o">,</span> <span class="n">ignorableTypes</span><span class="o">,</span> <span class="n">each</span><span class="o">);</span>
    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">&gt;</span> <span class="n">pModel</span> <span class="o">=</span> <span class="n">modelProvider</span><span class="o">.</span><span class="na">modelFor</span><span class="o">(</span><span class="n">each</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">pModel</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">mergeModelMap</span><span class="o">(</span><span class="n">modelMap</span><span class="o">,</span> <span class="n">pModel</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="o">}</span>
    <span class="n">populateDependencies</span><span class="o">(</span><span class="n">each</span><span class="o">,</span> <span class="n">modelMap</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">modelMap</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>就是从 <code>modelContexts</code>转化为 <code>Model</code>，看看<code>pluginsManager.modelContexts</code>，怎么取<code>modelContexts</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">ModelContext</span><span class="o">&gt;</span> <span class="nf">modelContexts</span><span class="o">(</span><span class="n">RequestMappingContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">DocumentationType</span> <span class="n">documentationType</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getDocumentationContext</span><span class="o">().</span><span class="na">getDocumentationType</span><span class="o">();</span>
  <span class="c1">// 构建接口的ModelContext集合
</span><span class="c1"></span>  <span class="k">for</span> <span class="o">(</span><span class="n">OperationModelsProviderPlugin</span> <span class="n">each</span> <span class="o">:</span> <span class="n">operationModelsProviders</span><span class="o">.</span><span class="na">getPluginsFor</span><span class="o">(</span><span class="n">documentationType</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">each</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">operationModelsBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>OperationModelsProviderPlugin</code>有两个实现类，通过文档类型来获取。</p>
<ul>
<li>OperationModelsProviderPlugin：处理返回类型，参数类型等</li>
<li>SwaggerOperationModelsProvider：swagger注解提供的值类型，<code>@ApiResponse</code>，<code>@ApiOperation</code>等</li>
</ul>
<p>先看<code>OperationModelsProviderPlugin</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="n">RequestMappingContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 收集返回类型
</span><span class="c1"></span>  <span class="n">collectFromReturnType</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="c1">// 收集参数类型
</span><span class="c1"></span>  <span class="n">collectParameters</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="c1">// 收集接口型号
</span><span class="c1"></span>  <span class="n">collectGlobalModels</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>到了这，本问题（ GET 方法的请求Object不描述）的答案就要呼之欲出了。来看 <code>collectParameters</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">collectParameters</span><span class="o">(</span><span class="n">RequestMappingContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 获取所有类型
</span><span class="c1"></span>  <span class="n">List</span><span class="o">&lt;</span><span class="n">ResolvedMethodParameter</span><span class="o">&gt;</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">ResolvedMethodParameter</span> <span class="n">parameterType</span> <span class="o">:</span> <span class="n">parameterTypes</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 过滤  
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">parameterType</span><span class="o">.</span><span class="na">hasParameterAnnotation</span><span class="o">(</span><span class="n">RequestBody</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
          <span class="o">||</span> <span class="n">parameterType</span><span class="o">.</span><span class="na">hasParameterAnnotation</span><span class="o">(</span><span class="n">RequestPart</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">ResolvedType</span> <span class="n">modelType</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">alternateFor</span><span class="o">(</span><span class="n">parameterType</span><span class="o">.</span><span class="na">getParameterType</span><span class="o">());</span>
        <span class="n">context</span><span class="o">.</span><span class="na">operationModelsBuilder</span><span class="o">().</span><span class="na">addInputParam</span><span class="o">(</span><span class="n">modelType</span><span class="o">);</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>破案了，可以看到过滤时只会处理两种：通过<code>@RequestBody</code>和<code>@ReuqestPart</code>注解标注的, 而GET方法的参数是不可以使用这两个注解的。（当然从规范来说，GET方法也不应该这种参数）。</p>
<p>至于<code>OperationModelsProviderPlugin</code>的另一个实现类<code>SwaggerOperationModelsProvider</code>主要是收集使用<code>@ApiOperation</code>时主句属性值和<code>@ApiResponse</code>响应状态码涉及到的型号，不再详细列出。</p>
<p>而<code>apiModelReader.read</code>中的 <code>modelContexts</code>转化为 <code>Model</code>的<code>modelProvider.modelFor()</code>是通过<code>ModelProvider</code>实现，下一个问题会详细阐述。</p>
<p>那么，如何解决这个问题：</p>
<ol>
<li>使用 <code>Docket</code>的<code>additionalModels</code>方法，在配置类中注入 <code>TypeResolver</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">return new Docket(DocumentationType.SWAGGER_2)
.additionalModels(typeResolver.resolve(xxx))
...
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>
<p>借助第三方类库 如<a href="https://github.com/xiaoymin/swagger-bootstrap-ui" target="_blank" rel="noopener noreffer">swagger-bootstrap-ui</a>的工具类（我没接，但可以..）</p>
</li>
<li>
<p>重写</p>
<p>重写<code>OperationModelsProviderPlugin</code>的<code>apply</code>方法，添加自定义收集器。或者直接重写 <code>collectParameters</code>也行。比如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">collectGetParameters</span><span class="o">(</span><span class="n">RequestMappingContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">ResolvedMethodParameter</span> <span class="n">parameterType</span> <span class="o">:</span> <span class="n">parameterTypes</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 不存在@RequestBody注解
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">parameterType</span><span class="o">.</span><span class="na">hasParameterAnnotation</span><span class="o">(</span><span class="n">RequestBody</span><span class="o">.</span><span class="na">class</span><span class="o">)...)</span> <span class="o">{</span>
                     <span class="o">...</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">xxx</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ResolvedType</span> <span class="n">modelType</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">alternateFor</span><span class="o">(</span><span class="n">parameterType</span><span class="o">.</span><span class="na">getParameterType</span><span class="o">());</span>
                <span class="n">context</span><span class="o">.</span><span class="na">operationModelsBuilder</span><span class="o">().</span><span class="na">addInputParam</span><span class="o">(</span><span class="n">modelType</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="o">...</span>
    <span class="o">}}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>问题解决。</p>
<h4 id="2-enum的描述格式">2. Enum的描述格式</h4>
<p>问题是对于枚举类，在生成的JSON文件中描述是在原参数对象中的如下格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JSON" data-lang="JSON">  <span class="s2">&#34;xxx&#34;</span><span class="err">:</span> <span class="p">{</span><span class="err">...</span><span class="p">}</span>
  <span class="s2">&#34;periodUnit&#34;</span><span class="err">:</span><span class="p">{</span>
     <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span>
     <span class="nt">&#34;enum&#34;</span><span class="p">:[</span>
              <span class="s2">&#34;MINUTE&#34;</span><span class="p">,</span>
              <span class="s2">&#34;HOUR&#34;</span>
              <span class="err">...</span>
        <span class="p">]}</span>
</code></pre></td></tr></table>
</div>
</div><p>一般枚举使用会如<code>MINUTE(1,“分钟”)</code>,也就是包括了<code>code</code>和<code>name</code>描述。</p>
<p>但实际<code>enum</code>的值会是二者之一。且不会生成如下的可重用的外部引用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JSON" data-lang="JSON"><span class="s2">&#34;schema&#34;</span><span class="err">:</span><span class="p">{</span>
         <span class="nt">&#34;$ref&#34;</span><span class="p">:</span><span class="s2">&#34;#/definitions/xxxForm&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>注意：可重用的问题在<code>3.0+</code>可以通过配置处理。</p>
<p>如果需要强制将<code>enum</code>的值设为<code>code</code>或<code>name</code>，或拓展更多的内容，就需要来看看，<code>enum</code>类何时会被处理。</p>
<p>上一个问题的结尾说到<code>apiModelReader.read</code>， <code>modelContexts</code>转化为 <code>Model</code>的<code>modelProvider.modelFor()</code>方法是通过<code>ModelProvider</code>实现，其实 ModelProvider`是接口，有两个实现类：</p>
<ul>
<li>DefaultModelProvider：默认，每次都会将modelContext转换为model</li>
<li>CachingModelProvider：声明了guava缓存池，先从缓存池取，没有则调用初始化处理器，转换为模型，再放入缓存池。</li>
</ul>
<p>在<code>ApiModelReader</code>的构造方法里指定了使用<code>CachingModelProvider</code>,不过第一次调用缓存里是没有的，所以往下走到<code>populateDependencies</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">populateDependencies</span><span class="o">(</span><span class="n">ModelContext</span> <span class="n">modelContext</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Model</span><span class="o">&gt;</span> <span class="n">modelMap</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Model</span><span class="o">&gt;</span> <span class="n">dependencies</span> <span class="o">=</span> <span class="n">modelProvider</span><span class="o">.</span><span class="na">dependencies</span><span class="o">(</span><span class="n">modelContext</span><span class="o">);</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">Model</span> <span class="n">each</span> <span class="o">:</span> <span class="n">dependencies</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">mergeModelMap</span><span class="o">(</span><span class="n">modelMap</span><span class="o">,</span> <span class="n">each</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>CachingModelProvider</code>的<code>dependencies</code>依赖的是<code>DefaultModelProvider</code>的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Model</span><span class="o">&gt;</span> <span class="nf">dependencies</span><span class="o">(</span><span class="n">ModelContext</span> <span class="n">modelContext</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">dependencies</span><span class="o">(</span><span class="n">modelContext</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>所以看<code>DefaultModelProvider</code>中的实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Model</span><span class="o">&gt;</span> <span class="nf">dependencies</span><span class="o">(</span><span class="n">ModelContext</span> <span class="n">modelContext</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Model</span><span class="o">&gt;</span> <span class="n">models</span> <span class="o">=</span> <span class="n">newHashMap</span><span class="o">();</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">ResolvedType</span> <span class="n">resolvedType</span> <span class="o">:</span> <span class="n">dependencyProvider</span><span class="o">.</span><span class="na">dependentModels</span><span class="o">(</span><span class="n">modelContext</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">ModelContext</span> <span class="n">parentContext</span> <span class="o">=</span> <span class="n">ModelContext</span><span class="o">.</span><span class="na">fromParent</span><span class="o">(</span><span class="n">modelContext</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">);</span>
    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">&gt;</span> <span class="n">model</span> <span class="o">=</span> <span class="n">modelFor</span><span class="o">(</span><span class="n">parentContext</span><span class="o">).</span><span class="na">or</span><span class="o">(</span><span class="n">mapModel</span><span class="o">(</span><span class="n">parentContext</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">model</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">models</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">model</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">model</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">models</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>dependencyProvider.dependentModels</code>和上面一个路子，一默认一缓存，交替接口。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">ResolvedType</span><span class="o">&gt;</span> <span class="nf">dependentModels</span><span class="o">(</span><span class="n">ModelContext</span> <span class="n">modelContext</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">from</span><span class="o">(</span><span class="n">resolvedDependencies</span><span class="o">(</span><span class="n">modelContext</span><span class="o">))</span>
      <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">ignorableTypes</span><span class="o">(</span><span class="n">modelContext</span><span class="o">))</span>
      <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">not</span><span class="o">(</span><span class="n">baseTypes</span><span class="o">(</span><span class="n">modelContext</span><span class="o">)))</span>
      <span class="o">.</span><span class="na">toSet</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>后面是两个过滤，暂且不提。看<code>resolvedDependencies</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ResolvedType</span><span class="o">&gt;</span> <span class="nf">resolvedDependencies</span><span class="o">(</span><span class="n">ModelContext</span> <span class="n">modelContext</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">ResolvedType</span><span class="o">&gt;</span> <span class="n">dependencies</span> <span class="o">=</span> <span class="n">newArrayList</span><span class="o">(</span><span class="n">resolvedTypeParameters</span><span class="o">(</span><span class="n">modelContext</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">));</span>
  <span class="n">dependencies</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">resolvedArrayElementType</span><span class="o">(</span><span class="n">modelContext</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">));</span>
  <span class="n">dependencies</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">resolvedPropertiesAndFields</span><span class="o">(</span><span class="n">modelContext</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">));</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里都是在构造拓展类型 <code>ResolvedType</code>,有一个叫<code>resolvedPropertiesAndFields</code>,看名字就是它了，进去</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ResolvedType</span><span class="o">&gt;</span> <span class="nf">resolvedPropertiesAndFields</span><span class="o">(</span><span class="n">ModelContext</span> <span class="n">modelContext</span><span class="o">,</span> <span class="n">ResolvedType</span> <span class="n">resolvedType</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">ResolvedType</span><span class="o">&gt;</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">newArrayList</span><span class="o">();</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">ModelProperty</span> <span class="n">property</span> <span class="o">:</span> <span class="n">nonTrivialProperties</span><span class="o">(</span><span class="n">modelContext</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">))</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">maybeFromCollectionElementType</span><span class="o">(</span><span class="n">modelContext</span><span class="o">,</span> <span class="n">property</span><span class="o">));</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">maybeFromMapValueType</span><span class="o">(</span><span class="n">modelContext</span><span class="o">,</span> <span class="n">property</span><span class="o">));</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">maybeFromRegularType</span><span class="o">(</span><span class="n">modelContext</span><span class="o">,</span> <span class="n">property</span><span class="o">));</span>
  <span class="o">}}</span>
</code></pre></td></tr></table>
</div>
</div><p>看到<code>ModelProperty</code>,也就是对象内部属性代表的Model了，那就看<code>nonTrivialProperties</code>方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="n">FluentIterable</span><span class="o">&lt;</span><span class="n">ModelProperty</span><span class="o">&gt;</span> <span class="nf">nonTrivialProperties</span><span class="o">(</span><span class="n">ModelContext</span> <span class="n">modelContext</span><span class="o">,</span> <span class="n">ResolvedType</span> <span class="n">resolvedType</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">from</span><span class="o">(</span><span class="n">propertiesFor</span><span class="o">(</span><span class="n">modelContext</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">))</span>
      <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">not</span><span class="o">(</span><span class="n">baseProperty</span><span class="o">(</span><span class="n">modelContext</span><span class="o">)));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>之后是<code>propertiesFor</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelProperty</span><span class="o">&gt;</span> <span class="nf">propertiesFor</span><span class="o">(</span><span class="n">ModelContext</span> <span class="n">modelContext</span><span class="o">,</span> <span class="n">ResolvedType</span> <span class="n">resolvedType</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">propertiesProvider</span><span class="o">.</span><span class="na">propertiesFor</span><span class="o">(</span><span class="n">resolvedType</span><span class="o">,</span> <span class="n">modelContext</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个<code>propertiesProvider.propertiesFor</code>仍是一cache一default的策略，直接看实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelProperty</span><span class="o">&gt;</span> <span class="nf">propertiesFor</span><span class="o">(</span><span class="n">ResolvedType</span> <span class="n">type</span><span class="o">,</span> <span class="n">ModelContext</span> <span class="n">givenContext</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">BeanPropertyDefinition</span><span class="o">&gt;</span> <span class="n">each</span> <span class="o">:</span> <span class="n">propertyLookup</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">BeanPropertyDefinition</span> <span class="n">jacksonProperty</span> <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">AnnotatedMember</span><span class="o">&gt;</span> <span class="n">annotatedMember</span>
        <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">fromNullable</span><span class="o">(</span><span class="n">safeGetPrimaryMember</span><span class="o">(</span><span class="n">jacksonProperty</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">annotatedMember</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">properties</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">candidateProperties</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">annotatedMember</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="n">jacksonProperty</span><span class="o">,</span> <span class="n">givenContext</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}...</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到 <code>List&lt;ModelProperty&gt; </code>通过 <code>candidateProperties</code>方法获取</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@VisibleForTesting</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">ModelProperty</span><span class="o">&gt;</span> <span class="nf">candidateProperties</span><span class="o">(</span>
    <span class="n">ResolvedType</span> <span class="n">type</span><span class="o">,</span>
    <span class="n">AnnotatedMember</span> <span class="n">member</span><span class="o">,</span>
    <span class="n">BeanPropertyDefinition</span> <span class="n">jacksonProperty</span><span class="o">,</span>
    <span class="n">ModelContext</span> <span class="n">givenContext</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelProperty</span><span class="o">&gt;</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">newArrayList</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">member</span> <span class="k">instanceof</span> <span class="n">AnnotatedMethod</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">findAccessorMethod</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">member</span><span class="o">)</span>
        <span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">propertyFromBean</span><span class="o">(</span><span class="n">givenContext</span><span class="o">,</span> <span class="n">jacksonProperty</span><span class="o">))</span>
        <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ModelProperty</span><span class="o">&gt;()));</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">member</span> <span class="k">instanceof</span> <span class="n">AnnotatedField</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">findField</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">jacksonProperty</span><span class="o">.</span><span class="na">getInternalName</span><span class="o">())</span>
        <span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">propertyFromField</span><span class="o">(</span><span class="n">givenContext</span><span class="o">,</span> <span class="n">jacksonProperty</span><span class="o">))</span>
        <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ModelProperty</span><span class="o">&gt;()));</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">member</span> <span class="k">instanceof</span> <span class="n">AnnotatedParameter</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ModelContext</span> <span class="n">modelContext</span> <span class="o">=</span> <span class="n">ModelContext</span><span class="o">.</span><span class="na">fromParent</span><span class="o">(</span><span class="n">givenContext</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">fromFactoryMethod</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">jacksonProperty</span><span class="o">,</span> <span class="o">(</span><span class="n">AnnotatedParameter</span><span class="o">)</span> <span class="n">member</span><span class="o">,</span> <span class="n">modelContext</span><span class="o">));</span>
  <span class="o">}</span>
 <span class="o">...</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里根据 <code>AnnotatedMember</code>判断类成员的类型，进行不同的处理。enum使用的是 <code>propertyFromBean</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java">  <span class="o">...</span>
  <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelProperty</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="n">ResolvedMethod</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ResolvedType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">paramOrReturnType</span><span class="o">(</span><span class="n">typeResolver</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">givenContext</span><span class="o">.</span><span class="na">canIgnore</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">shouldUnwrap</span><span class="o">(</span><span class="n">input</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">propertiesFor</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">fromParent</span><span class="o">(</span><span class="n">givenContext</span><span class="o">,</span> <span class="n">type</span><span class="o">));</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">newArrayList</span><span class="o">(</span><span class="n">beanModelProperty</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">jacksonProperty</span><span class="o">,</span> <span class="n">givenContext</span><span class="o">));</span>
    <span class="o">}...</span>
    <span class="o">}};</span>
</code></pre></td></tr></table>
</div>
</div><p>接着是 <code>beanModelProperty</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">ModelProperty</span> <span class="nf">beanModelProperty</span><span class="o">(</span>
    <span class="o">...</span>
  <span class="k">return</span> <span class="n">schemaPluginsManager</span><span class="o">.</span><span class="na">property</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">ModelPropertyContext</span><span class="o">(</span><span class="n">propertyBuilder</span><span class="o">,</span>
          <span class="n">jacksonProperty</span><span class="o">,</span>
          <span class="n">typeResolver</span><span class="o">,</span>
          <span class="o">...</span>
</code></pre></td></tr></table>
</div>
</div><p>最后调用了 <code>schemaPluginsManager.property</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">ModelProperty</span> <span class="nf">property</span><span class="o">(</span><span class="n">ModelPropertyContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 根据文档类型取出 ModelPropertyBuilderPlugin
</span><span class="c1"></span>  <span class="k">for</span> <span class="o">(</span><span class="n">ModelPropertyBuilderPlugin</span> <span class="n">enricher</span> <span class="o">:</span> <span class="n">propertyEnrichers</span><span class="o">.</span><span class="na">getPluginsFor</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getDocumentationType</span><span class="o">()))</span> <span class="o">{</span>
    <span class="n">enricher</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ModelPropertyBuilderPlugin</code>是一个接口，看它的其中一个实现类<code>ApiModelPropertyPropertyBuilder</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="n">ModelPropertyContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 取出元素的注解
</span><span class="c1"></span>  <span class="n">Optional</span><span class="o">&lt;</span><span class="n">ApiModelProperty</span><span class="o">&gt;</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">absent</span><span class="o">();</span>
  <span class="o">...</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">context</span><span class="o">.</span><span class="na">getBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">allowableValues</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">toAllowableValues</span><span class="o">()).</span><span class="na">orNull</span><span class="o">())</span>
        <span class="o">.</span><span class="na">required</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">toIsRequired</span><span class="o">()).</span><span class="na">or</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span>
        <span class="o">.</span><span class="na">readOnly</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">toIsReadOnly</span><span class="o">()).</span><span class="na">or</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span>
        <span class="o">.</span><span class="na">description</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">toDescription</span><span class="o">()).</span><span class="na">orNull</span><span class="o">())</span>
        <span class="o">.</span><span class="na">isHidden</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">toHidden</span><span class="o">()).</span><span class="na">or</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span>
        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">toType</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getResolver</span><span class="o">())).</span><span class="na">orNull</span><span class="o">())</span>
        <span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">toPosition</span><span class="o">()).</span><span class="na">or</span><span class="o">(</span><span class="n">0</span><span class="o">))</span>
        <span class="o">.</span><span class="na">example</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">toExample</span><span class="o">()).</span><span class="na">orNull</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到通过判断是否存在注解，再设置具体的配置。</p>
<p>其中<code>type</code>就是<code>enum</code>展示的类型了，可以固定。<code> allowableValues</code>就是<code>enum</code>的<code>value</code>,可以自定义，还可以加入<code>description</code>.</p>
<p>具体实现可以通过重写<code>ApiModelPropertyPropertyBuilder</code>的<code>apply</code>实现。</p>
<p>到这里，两个问题都得到解决。Springfox的加载过程也基本介绍了一遍。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2019-12-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://llc687.top/posts/java/springfox%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%87%AA%E5%AE%9A%E4%B9%89modelenum/" data-title="SpringFox源码解析" data-hashtags="SpringFox,Swagger"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://llc687.top/posts/java/springfox%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%87%AA%E5%AE%9A%E4%B9%89modelenum/" data-hashtag="SpringFox"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://llc687.top/posts/java/springfox%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%87%AA%E5%AE%9A%E4%B9%89modelenum/" data-title="SpringFox源码解析"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://llc687.top/posts/java/springfox%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%87%AA%E5%AE%9A%E4%B9%89modelenum/" data-title="SpringFox源码解析"><i data-svg-src="/lib/simple-icons/icons/baidu.min.svg"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://llc687.top/posts/java/springfox%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%87%AA%E5%AE%9A%E4%B9%89modelenum/" data-title="SpringFox源码解析"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/springfox/">SpringFox</a>,&nbsp;<a href="/tags/swagger/">Swagger</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/hadoop%E4%B8%8Ehive/" class="prev" rel="prev" title="“MapReduce及Hive&#34;"><i class="fas fa-angle-left fa-fw"></i>“MapReduce及Hive&#34;</a>
            <a href="/posts/java/swagger-codegen%E4%BD%BF%E7%94%A8/" class="next" rel="next" title="Swagger-Codegen使用">Swagger-Codegen使用<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="utterances"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">Utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.81.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2018 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">lyf687</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.fill%2CArray.prototype.find%2CArray.from%2CIntersectionObserver%2CMath.sign%2CObject.assign%2CPromise%2CObject.entries%2CElement.prototype.closest%2CrequestAnimationFrame%2CCustomEvent%2Chtml5shiv%2CObject.values%2Cfetch%2CElement.prototype.after"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/twemoji/twemoji.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"liyifan687/comments"}},"data":{"id-1":"无名鼠辈","id-2":"无名鼠辈"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"","algoliaIndex":"","algoliaSearchKey":"","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', '014783502852757998779:nk1fvw21g2i', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=014783502852757998779:nk1fvw21g2i" async></script></body>
</html>
